<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IELTS Writing Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50 text-gray-800">
  <!-- TOEFL Scoring Rubric Sidebar -->
  <div id="scoring-sidebar" class="fixed left-0 top-0 h-full w-80 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-blue-600">IELTS Scoring Rubric</h3>
        <button id="close-sidebar" class="text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      <div class="text-sm space-y-4">
        <div class="bg-green-50 p-3 rounded">
          <h4 class="font-bold text-green-700">Score 5 (Excellent)</h4>
          <ul class="text-xs mt-2 space-y-1">
            <li>‚Ä¢ Effectively addresses the topic and task</li>
            <li>‚Ä¢ Well organized and developed</li>
            <li>‚Ä¢ Displays unity, progression, and coherence</li>
            <li>‚Ä¢ Consistent facility in language use</li>
          </ul>
        </div>
        <div class="bg-blue-50 p-3 rounded">
          <h4 class="font-bold text-blue-700">Score 4 (Good)</h4>
          <ul class="text-xs mt-2 space-y-1">
            <li>‚Ä¢ Addresses the topic well</li>
            <li>‚Ä¢ Generally well organized</li>
            <li>‚Ä¢ Good unity and progression</li>
            <li>‚Ä¢ Occasional minor errors</li>
          </ul>
        </div>
        <div class="bg-yellow-50 p-3 rounded">
          <h4 class="font-bold text-yellow-700">Score 3 (Fair)</h4>
          <ul class="text-xs mt-2 space-y-1">
            <li>‚Ä¢ Somewhat developed explanations</li>
            <li>‚Ä¢ Ideas may be occasionally obscured</li>
            <li>‚Ä¢ Inconsistent sentence formation</li>
          </ul>
        </div>
        <div class="bg-orange-50 p-3 rounded">
          <h4 class="font-bold text-orange-700">Score 2 (Limited)</h4>
          <ul class="text-xs mt-2 space-y-1">
            <li>‚Ä¢ Limited development</li>
            <li>‚Ä¢ Inadequate organization</li>
            <li>‚Ä¢ Errors in sentence structure</li>
          </ul>
        </div>
        <div class="bg-red-50 p-3 rounded">
          <h4 class="font-bold text-red-700">Score 1 (Seriously Flawed)</h4>
          <ul class="text-xs mt-2 space-y-1">
            <li>‚Ä¢ Serious disorganization</li>
            <li>‚Ä¢ Little or no detail</li>
            <li>‚Ä¢ Frequent errors</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Timer Sidebar -->
  <div id="timer-sidebar" class="fixed right-0 top-0 h-full w-64 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-50">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-green-600">Writing Timer</h3>
        <button id="close-timer" class="text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      <div class="text-center">
        <div id="timer-display" class="text-4xl font-bold text-gray-800 mb-4">30:00</div>
        <div class="space-y-2">
          <button id="start-timer" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">Start Timer</button>
          <button id="pause-timer" class="w-full bg-yellow-600 text-white py-2 px-4 rounded hover:bg-yellow-700">Pause</button>
          <button id="reset-timer" class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">Reset</button>
        </div>
        <div id="timer-warning" class="mt-4 text-red-600 font-bold hidden">‚ö†Ô∏è 5 minutes left!</div>
      </div>
    </div>
  </div>

  <!-- Toggle Buttons -->
  <button id="show-sidebar" class="fixed left-4 top-4 bg-blue-600 text-white px-3 py-2 rounded-r hover:bg-blue-700 z-40">
    üìä Scoring Guide
  </button>
  <button id="show-timer" class="fixed right-4 top-4 bg-green-600 text-white px-3 py-2 rounded-l hover:bg-green-700 z-40">
    ‚è±Ô∏è Timer
  </button>

  <div class="max-w-5xl mx-auto p-6">
    <!-- IELTS Prompt Selection Section -->
    <div class="bg-white shadow p-4 rounded-xl mb-6">
      <h2 class="text-xl font-semibold mb-2">üá¨üáß IELTS Writing Assistant</h2>
      <p class="text-gray-600 mb-4">AI-powered analysis for International English Language Testing System writing tasks</p>
      <div class="mb-4">
        <a href="/" class="text-blue-600 hover:text-blue-800 text-sm">‚Üê Back to Test Selection</a>
      </div>
      <h3 class="text-lg font-semibold mb-2">Select an IELTS Writing Prompt</h3>
      <select id="prompt" class="w-full p-2 border rounded mb-4">
        <option value="1">People attend college or university for many different reasons (for example, new experiences, career preparation, increased knowledge). Why do you think people attend college or university? Use specific reasons and examples to support your answer.</option>
        <option value="2">Do you agree or disagree with the following statement? Parents are the best teachers. Use specific reasons and examples to support your answer.</option>
        <option value="3">Nowadays, food has become easier to prepare. Has this change improved the way people live? Use specific reasons and examples to support your answer.</option>
        <option value="4">It has been said, ‚ÄúNot everything that is learned is contained in books.‚Äù Compare and contrast knowledge gained from experience with knowledge gained from books. In your opinion, which source is more important? Why?</option>
        <option value="5">A company has announced that it wishes to build a large factory near your community. Discuss the advantages and disadvantages of this new influence on your community. Do you support or oppose the factory? Explain your position.</option>
        <option value="6">If you could change one important thing about your hometown, what would you change? Use reasons and specific examples to support your answer.</option>
        <option value="7">How do movies or television influence people‚Äôs behavior? Use reasons and specific examples to support your answer.</option>
      </select>
      
      <!-- Mode Selection Tabs -->
      <div class="flex mb-4 border-b">
        <button id="tab-generate" class="tab-button flex-1 py-2 px-4 text-center border-b-2 border-blue-600 text-blue-600 font-semibold">Generate Sample by ChatGPT</button>
        <button id="tab-write" class="tab-button flex-1 py-2 px-4 text-center border-b-2 border-transparent text-gray-600">Write Your Own Essay</button>
      </div>
      
      <!-- Generate Mode Content -->
      <div id="generate-mode" class="mode-content">
        <button id="generate" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Generate Sample by ChatGPT</button>
      </div>
      
      <!-- Write Mode Content -->
      <div id="write-mode" class="mode-content hidden">
        <p class="text-sm text-gray-600 mb-3">üí° Tip: You have 30 minutes to write your essay. Use the timer on the right to track your time!</p>
        
        <!-- Main Writing Interface -->
        <div class="relative">
          <!-- Writing Area - Full Width by Default -->
          <div id="writing-container" class="transition-all duration-300 ease-in-out">
            <div class="flex justify-between items-center mb-3">
              <h4 class="font-semibold text-gray-700">‚úçÔ∏è Your Essay</h4>
              <div class="flex space-x-2">
                <button id="toggle-analysis" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition-colors">
                  üìä Show Analysis
                </button>
                <button id="check-writing" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600">
                  üîç Check Writing
                </button>
                <button id="clear-highlights" class="bg-gray-500 text-white px-3 py-2 rounded text-sm hover:bg-gray-600">
                  Clear
                </button>
              </div>
            </div>
            
            <!-- Rich Text Editor Area -->
            <div class="relative mb-4">
              <div id="writing-display" class="absolute inset-0 p-4 border rounded-lg bg-white pointer-events-none z-10 opacity-0 transition-opacity duration-300" style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; font-size: 14px;"></div>
              <textarea id="user-essay" class="w-full p-4 border rounded-lg resize-none relative z-20 bg-transparent focus:bg-white transition-colors" rows="20" style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; line-height: 1.6; font-size: 14px;" placeholder="Start writing your TOEFL essay here...

Remember to:
‚Ä¢ Clearly state your position in the introduction
‚Ä¢ Use specific examples and details to support your arguments
‚Ä¢ Organize your ideas logically with clear transitions
‚Ä¢ Aim for 300-400 words
‚Ä¢ Conclude by restating your main points

Good luck! üöÄ"></textarea>
            </div>
            
            <!-- Stats and Actions -->
            <div class="flex justify-between items-center">
              <div class="flex space-x-6 text-sm text-gray-600">
                <span id="word-count" class="font-medium">Words: 0</span>
                <span id="char-count">Characters: 0</span>
                <span id="sentence-count">Sentences: 0</span>
                <span id="paragraph-count">Paragraphs: 0</span>
              </div>
              <button id="score-user-essay" class="bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 px-8 rounded-lg hover:from-green-600 hover:to-blue-600 transition-all duration-200 font-medium shadow-lg">
                üéØ Score My Essay
              </button>
            </div>
          </div>
          
          <!-- Analysis Panel - Hidden by Default -->
          <div id="analysis-panel" class="fixed right-0 top-0 h-full w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-50 border-l">
            <div class="p-6 h-full flex flex-col">
              <!-- Panel Header -->
              <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h4 class="font-bold text-gray-800 text-lg">üìä Writing Analysis</h4>
                <button id="close-analysis" class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
              </div>
              
              <!-- Analysis Tabs -->
              <div class="flex mb-4 border-b overflow-x-auto">
                <button id="tab-errors" class="feedback-tab flex-shrink-0 px-2 py-2 text-xs border-b-2 border-red-500 text-red-600 font-semibold">
                  <span class="inline-block w-2 h-2 bg-red-200 rounded mr-1"></span>Errors
                </button>
                <button id="tab-strengths" class="feedback-tab flex-shrink-0 px-2 py-2 text-xs border-b-2 border-transparent text-gray-600">
                  <span class="inline-block w-2 h-2 bg-green-200 rounded mr-1"></span>Strengths
                </button>
                <button id="tab-vocabulary" class="feedback-tab flex-shrink-0 px-2 py-2 text-xs border-b-2 border-transparent text-gray-600">
                  <span class="inline-block w-2 h-2 bg-blue-200 rounded mr-1"></span>Vocab
                </button>
                <button id="tab-structure" class="feedback-tab flex-shrink-0 px-2 py-2 text-xs border-b-2 border-transparent text-gray-600">
                  <span class="inline-block w-2 h-2 bg-purple-200 rounded mr-1"></span>Structure
                </button>
                <button id="tab-toefl" class="feedback-tab flex-shrink-0 px-2 py-2 text-xs border-b-2 border-transparent text-gray-600">
                  <span class="inline-block w-2 h-2 bg-indigo-200 rounded mr-1"></span>TOEFL
                </button>
                <button id="tab-overall" class="feedback-tab flex-shrink-0 px-2 py-2 text-xs border-b-2 border-transparent text-gray-600">
                  <span class="inline-block w-2 h-2 bg-gray-200 rounded mr-1"></span>Summary
                </button>
              </div>
              
              <!-- Feedback Content -->
              <div id="feedback-content" class="flex-1 overflow-y-auto">
                <!-- Errors Panel -->
                <div id="feedback-errors" class="feedback-panel">
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">‚úçÔ∏è</div>
                    <p class="text-sm">Start writing to see spelling and grammar checks...</p>
                  </div>
                </div>
                
                <!-- Strengths Panel -->
                <div id="feedback-strengths" class="feedback-panel hidden">
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üåü</div>
                    <p class="text-sm">Your writing strengths will appear here...</p>
                  </div>
                </div>
                
                <!-- Vocabulary Panel -->
                <div id="feedback-vocabulary" class="feedback-panel hidden">
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üìö</div>
                    <p class="text-sm">Vocabulary analysis will appear here...</p>
                  </div>
                </div>
                
                <!-- Structure Panel -->
                <div id="feedback-structure" class="feedback-panel hidden">
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üèóÔ∏è</div>
                    <p class="text-sm">Writing structure analysis will appear here...</p>
                  </div>
                </div>
                
                <!-- TOEFL Tips Panel -->
                <div id="feedback-toefl" class="feedback-panel hidden">
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üéØ</div>
                    <p class="text-sm">TOEFL-specific tips will appear here...</p>
                  </div>
                </div>
                
                <!-- Overall Assessment Panel -->
                <div id="feedback-overall" class="feedback-panel hidden">
                  <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üìä</div>
                    <p class="text-sm">Overall assessment will appear here...</p>
                  </div>
                </div>
              </div>
              
              <!-- Legend -->
              <div class="mt-4 pt-4 border-t">
                <p class="text-xs font-semibold text-gray-600 mb-2">Color Legend:</p>
                <div class="grid grid-cols-2 gap-1 text-xs">
                  <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-red-200 rounded border border-red-300"></span>
                    <span>Errors</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-green-200 rounded border border-green-300"></span>
                    <span>Strengths</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-blue-200 rounded border border-blue-300"></span>
                    <span>Vocabulary</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-yellow-200 rounded border border-yellow-300"></span>
                    <span>Improve</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sample Generation Section -->
    <div class="bg-white shadow p-4 rounded-xl" id="sample-section">
      <h2 class="text-xl font-semibold mb-2">Generated Sample Answer</h2>
      <div id="sample" class="w-full border rounded mb-2 text-gray-700 min-h-[200px]"></div>
      <button id="score" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 mt-4" style="display: none;">Score This Essay</button>
    </div>

    <!-- Scoring Section -->
    <div class="bg-white shadow p-4 rounded-xl mt-6" id="scoring-section" style="display: none;">
      <h2 class="text-xl font-semibold mb-2">Essay Scoring & Analysis</h2>
      <div id="scoring" class="w-full border rounded mb-2 text-gray-700 min-h-[200px]"></div>
    </div>
  </div>

  <script>
    let currentEssay = '';
    let currentPrompt = '';
    let timerInterval = null;
    let timeLeft = 30 * 60; // 30 minutes in seconds
    let isRunning = false;

    // Timer functions
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('timer-display').textContent = display;
      
      // Flash warning when 5 minutes left
      if (timeLeft <= 5 * 60 && timeLeft > 0) {
        document.getElementById('timer-warning').classList.remove('hidden');
        if (timeLeft <= 5 * 60 && timeLeft % 2 === 0) {
          document.getElementById('timer-display').classList.add('text-red-600');
          document.getElementById('timer-display').style.animation = 'blink 1s infinite';
        }
      } else {
        document.getElementById('timer-warning').classList.add('hidden');
        document.getElementById('timer-display').classList.remove('text-red-600');
        document.getElementById('timer-display').style.animation = 'none';
      }
      
      if (timeLeft === 0) {
        clearInterval(timerInterval);
        isRunning = false;
        alert('Time is up! 30 minutes have elapsed.');
      }
    }

    function startTimer() {
      if (!isRunning) {
        isRunning = true;
        timerInterval = setInterval(() => {
          timeLeft--;
          updateTimerDisplay();
        }, 1000);
      }
    }

    function pauseTimer() {
      clearInterval(timerInterval);
      isRunning = false;
    }

    function resetTimer() {
      clearInterval(timerInterval);
      isRunning = false;
      timeLeft = 30 * 60;
      updateTimerDisplay();
    }

    // Sidebar functions
    function showSidebar() {
      document.getElementById('scoring-sidebar').classList.remove('-translate-x-full');
      document.getElementById('show-sidebar').classList.add('hidden');
    }

    function hideSidebar() {
      document.getElementById('scoring-sidebar').classList.add('-translate-x-full');
      document.getElementById('show-sidebar').classList.remove('hidden');
    }

    function showTimer() {
      document.getElementById('timer-sidebar').classList.remove('translate-x-full');
      document.getElementById('show-timer').classList.add('hidden');
    }

    function hideTimer() {
      document.getElementById('timer-sidebar').classList.add('translate-x-full');
      document.getElementById('show-timer').classList.remove('hidden');
    }

    // Event listeners
    document.getElementById('show-sidebar').addEventListener('click', showSidebar);
    document.getElementById('close-sidebar').addEventListener('click', hideSidebar);
    document.getElementById('show-timer').addEventListener('click', showTimer);
    document.getElementById('close-timer').addEventListener('click', hideTimer);
    
    document.getElementById('start-timer').addEventListener('click', startTimer);
    document.getElementById('pause-timer').addEventListener('click', pauseTimer);
    document.getElementById('reset-timer').addEventListener('click', resetTimer);

    // Initialize timer display
    updateTimerDisplay();

    // Mode switching functions
    function showGenerateMode() {
      document.getElementById('generate-mode').classList.remove('hidden');
      document.getElementById('write-mode').classList.add('hidden');
      document.getElementById('sample-section').style.display = 'block';
      
      // Update tab styles
      document.getElementById('tab-generate').classList.add('border-blue-600', 'text-blue-600', 'font-semibold');
      document.getElementById('tab-generate').classList.remove('border-transparent', 'text-gray-600');
      document.getElementById('tab-write').classList.add('border-transparent', 'text-gray-600');
      document.getElementById('tab-write').classList.remove('border-blue-600', 'text-blue-600', 'font-semibold');
    }

    function showWriteMode() {
      document.getElementById('generate-mode').classList.add('hidden');
      document.getElementById('write-mode').classList.remove('hidden');
      document.getElementById('sample-section').style.display = 'none';
      
      // Update tab styles
      document.getElementById('tab-write').classList.add('border-blue-600', 'text-blue-600', 'font-semibold');
      document.getElementById('tab-write').classList.remove('border-transparent', 'text-gray-600');
      document.getElementById('tab-generate').classList.add('border-transparent', 'text-gray-600');
      document.getElementById('tab-generate').classList.remove('border-blue-600', 'text-blue-600', 'font-semibold');
    }

    // Writing analysis variables
    let currentAnalysis = null;
    let highlightTimeout = null;

    // Enhanced word count function
    function updateWordCount() {
      const text = document.getElementById('user-essay').value;
      const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      const chars = text.length;
      const sentences = text.trim() === '' ? 0 : text.split(/[.!?]+/).filter(s => s.trim().length > 0).length;
      const paragraphs = text.trim() === '' ? 0 : text.split(/\n\s*\n/).filter(p => p.trim().length > 0).length;
      
      document.getElementById('word-count').textContent = `Words: ${words}`;
      document.getElementById('char-count').textContent = `Characters: ${chars}`;
      document.getElementById('sentence-count').textContent = `Sentences: ${sentences}`;
      document.getElementById('paragraph-count').textContent = `Paragraphs: ${paragraphs}`;
      
      // Auto-check writing after user stops typing for 3 seconds
      clearTimeout(highlightTimeout);
      if (words > 10) {
        highlightTimeout = setTimeout(() => {
          checkWritingAutomatically();
        }, 3000);
      }
    }

    // Analysis panel toggle functions
    function showAnalysisPanel() {
      document.getElementById('analysis-panel').classList.remove('translate-x-full');
      document.getElementById('toggle-analysis').innerHTML = 'üìä Hide Analysis';
      document.getElementById('toggle-analysis').classList.remove('bg-blue-500', 'hover:bg-blue-600');
      document.getElementById('toggle-analysis').classList.add('bg-gray-500', 'hover:bg-gray-600');
    }

    function hideAnalysisPanel() {
      document.getElementById('analysis-panel').classList.add('translate-x-full');
      document.getElementById('toggle-analysis').innerHTML = 'üìä Show Analysis';
      document.getElementById('toggle-analysis').classList.remove('bg-gray-500', 'hover:bg-gray-600');
      document.getElementById('toggle-analysis').classList.add('bg-blue-500', 'hover:bg-blue-600');
    }

    function toggleAnalysisPanel() {
      const panel = document.getElementById('analysis-panel');
      if (panel.classList.contains('translate-x-full')) {
        showAnalysisPanel();
      } else {
        hideAnalysisPanel();
      }
    }

    // Feedback tab switching
    function switchFeedbackTab(tabName) {
      // Update tab styles
      document.querySelectorAll('.feedback-tab').forEach(tab => {
        tab.classList.remove('border-red-500', 'text-red-600', 'border-green-500', 'text-green-600', 'border-blue-500', 'text-blue-600', 'border-purple-500', 'text-purple-600', 'border-indigo-500', 'text-indigo-600', 'border-gray-500', 'text-gray-800', 'font-semibold');
        tab.classList.add('border-transparent', 'text-gray-600');
      });
      
      // Hide all panels
      document.querySelectorAll('.feedback-panel').forEach(panel => {
        panel.classList.add('hidden');
      });
      
      // Show selected tab and panel
      const selectedTab = document.getElementById(`tab-${tabName}`);
      const selectedPanel = document.getElementById(`feedback-${tabName}`);
      
      if (selectedTab && selectedPanel) {
        selectedPanel.classList.remove('hidden');
        
        // Set appropriate colors for each tab
        switch(tabName) {
          case 'errors':
            selectedTab.classList.add('border-red-500', 'text-red-600', 'font-semibold');
            break;
          case 'strengths':
            selectedTab.classList.add('border-green-500', 'text-green-600', 'font-semibold');
            break;
          case 'vocabulary':
            selectedTab.classList.add('border-blue-500', 'text-blue-600', 'font-semibold');
            break;
          case 'structure':
            selectedTab.classList.add('border-purple-500', 'text-purple-600', 'font-semibold');
            break;
          case 'toefl':
            selectedTab.classList.add('border-indigo-500', 'text-indigo-600', 'font-semibold');
            break;
          case 'overall':
            selectedTab.classList.add('border-gray-500', 'text-gray-800', 'font-semibold');
            break;
        }
      }
    }

    // Automatic writing check (less intrusive)
    async function checkWritingAutomatically() {
      const text = document.getElementById('user-essay').value.trim();
      if (text.length < 50) return;
      
      try {
        const response = await fetch('/analyze_writing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ essay: text })
        });
        
        const data = await response.json();
        if (data.analysis) {
          currentAnalysis = data.analysis;
          updateFeedbackPanels();
        }
      } catch (error) {
        console.log('Auto-analysis failed:', error);
      }
    }

    // Manual writing check with full highlighting
    async function checkWritingManually() {
      const text = document.getElementById('user-essay').value.trim();
      if (!text) {
        alert('Please write something first!');
        return;
      }
      
      // Show loading
      document.getElementById('feedback-errors').innerHTML = '<div class="text-blue-600">üîç Analyzing your writing...</div>';
      
      try {
        const response = await fetch('/analyze_writing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ essay: text })
        });
        
        const data = await response.json();
        if (data.analysis) {
          currentAnalysis = data.analysis;
          updateFeedbackPanels();
          highlightText();
        }
      } catch (error) {
        document.getElementById('feedback-errors').innerHTML = '<div class="text-red-600">Error analyzing writing. Please try again.</div>';
      }
    }

    // Update feedback panels with analysis data - Enhanced version
    function updateFeedbackPanels() {
      if (!currentAnalysis) return;
      
      // Update errors panel
      updateErrorsPanel();
      
      // Update strengths panel
      updateStrengthsPanel();
      
      // Update vocabulary panel
      updateVocabularyPanel();
      
      // Update structure panel
      updateStructurePanel();
      
      // Update TOEFL tips panel
      updateTOEFLPanel();
      
      // Update overall assessment panel
      updateOverallPanel();
    }

    function updateErrorsPanel() {
      let errorsHTML = '';
      
      if (currentAnalysis.spelling_errors && currentAnalysis.spelling_errors.length > 0) {
        errorsHTML += '<div class="mb-4"><h5 class="font-semibold text-red-600 mb-3 flex items-center"><span class="text-lg mr-2">üî§</span>Spelling Errors</h5>';
        currentAnalysis.spelling_errors.forEach(error => {
          const severityColor = error.severity === 'high' ? 'red' : error.severity === 'medium' ? 'yellow' : 'orange';
          errorsHTML += `
            <div class="mb-3 p-3 bg-${severityColor}-50 border-l-4 border-${severityColor}-400 rounded-r">
              <div class="font-medium text-${severityColor}-700">"${error.word}"</div>
              <div class="text-sm text-gray-600 mt-1">üí° Suggestions: ${error.suggestions.join(', ')}</div>
              ${error.context ? `<div class="text-xs text-gray-500 mt-1 italic">"${error.context}"</div>` : ''}
            </div>`;
        });
        errorsHTML += '</div>';
      }
      
      if (currentAnalysis.grammar_issues && currentAnalysis.grammar_issues.length > 0) {
        errorsHTML += '<div class="mb-4"><h5 class="font-semibold text-red-600 mb-3 flex items-center"><span class="text-lg mr-2">üìù</span>Grammar Issues</h5>';
        currentAnalysis.grammar_issues.forEach(issue => {
          const severityColor = issue.severity === 'high' ? 'red' : issue.severity === 'medium' ? 'yellow' : 'orange';
          errorsHTML += `
            <div class="mb-3 p-3 bg-${severityColor}-50 border-l-4 border-${severityColor}-400 rounded-r">
              <div class="font-medium text-${severityColor}-700">${issue.issue}</div>
              <div class="text-sm text-gray-600 mt-1">‚ùå "${issue.text}" ‚Üí ‚úÖ "${issue.suggestion}"</div>
              ${issue.explanation ? `<div class="text-xs text-gray-500 mt-1 italic">${issue.explanation}</div>` : ''}
            </div>`;
        });
        errorsHTML += '</div>';
      }
      
      if (currentAnalysis.weaknesses && currentAnalysis.weaknesses.length > 0) {
        errorsHTML += '<div class="mb-4"><h5 class="font-semibold text-yellow-600 mb-3 flex items-center"><span class="text-lg mr-2">‚ö†Ô∏è</span>Areas for Improvement</h5>';
        currentAnalysis.weaknesses.forEach(weakness => {
          errorsHTML += `
            <div class="mb-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded-r">
              <div class="font-medium text-yellow-700">${weakness.issue}</div>
              <div class="text-sm text-gray-600 mt-1">"${weakness.text}"</div>
              <div class="text-sm text-blue-600 mt-1">üí° ${weakness.suggestion}</div>
            </div>`;
        });
        errorsHTML += '</div>';
      }
      
      if (!errorsHTML) {
        errorsHTML = `
          <div class="text-center py-8 text-green-600">
            <div class="text-4xl mb-2">‚úÖ</div>
            <div class="font-semibold">Excellent work!</div>
            <div class="text-sm text-gray-600">No major errors detected.</div>
          </div>`;
      }
      
      document.getElementById('feedback-errors').innerHTML = errorsHTML;
    }

    function updateStrengthsPanel() {
      let strengthsHTML = '';
      
      if (currentAnalysis.strengths && currentAnalysis.strengths.length > 0) {
        strengthsHTML += '<div class="mb-4"><h5 class="font-semibold text-green-600 mb-3 flex items-center"><span class="text-lg mr-2">üí™</span>Writing Strengths</h5>';
        currentAnalysis.strengths.forEach(strength => {
          strengthsHTML += `
            <div class="mb-3 p-3 bg-green-50 border-l-4 border-green-400 rounded-r">
              <div class="font-medium text-green-700">"${strength.text}"</div>
              <div class="text-sm text-gray-600 mt-1">${strength.reason}</div>
              <div class="text-xs text-green-600 mt-1 font-medium">Category: ${strength.category}</div>
            </div>`;
        });
        strengthsHTML += '</div>';
      }
      
      if (currentAnalysis.sentence_structure && currentAnalysis.sentence_structure.length > 0) {
        strengthsHTML += '<div class="mb-4"><h5 class="font-semibold text-green-600 mb-3 flex items-center"><span class="text-lg mr-2">üèóÔ∏è</span>Excellent Sentence Structure</h5>';
        currentAnalysis.sentence_structure.forEach(structure => {
          strengthsHTML += `
            <div class="mb-3 p-3 bg-green-50 border-l-4 border-green-400 rounded-r">
              <div class="font-medium text-green-700">"${structure.text.length > 60 ? structure.text.substring(0, 60) + '...' : structure.text}"</div>
              <div class="text-sm text-gray-600 mt-1">${structure.feedback}</div>
              <div class="text-xs text-green-600 mt-1 font-medium">Type: ${structure.type}</div>
            </div>`;
        });
        strengthsHTML += '</div>';
      }
      
      if (currentAnalysis.transitions && currentAnalysis.transitions.length > 0) {
        strengthsHTML += '<div class="mb-4"><h5 class="font-semibold text-green-600 mb-3 flex items-center"><span class="text-lg mr-2">üîó</span>Effective Transitions</h5>';
        currentAnalysis.transitions.forEach(transition => {
          strengthsHTML += `
            <div class="mb-3 p-3 bg-green-50 border-l-4 border-green-400 rounded-r">
              <div class="font-medium text-green-700">"${transition.text}"</div>
              <div class="text-sm text-gray-600 mt-1">${transition.feedback}</div>
              <div class="text-xs text-green-600 mt-1 font-medium">Function: ${transition.function || transition.type}</div>
            </div>`;
        });
        strengthsHTML += '</div>';
      }
      
      if (!strengthsHTML) {
        strengthsHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üåü</div>
            <div class="font-semibold">Keep writing!</div>
            <div class="text-sm">Your strengths will appear here as you write more.</div>
          </div>`;
      }
      
      document.getElementById('feedback-strengths').innerHTML = strengthsHTML;
    }

    function updateVocabularyPanel() {
      let vocabHTML = '';
      
      if (currentAnalysis.vocabulary_highlights && currentAnalysis.vocabulary_highlights.length > 0) {
        vocabHTML += '<div class="mb-4"><h5 class="font-semibold text-blue-600 mb-3 flex items-center"><span class="text-lg mr-2">üìö</span>Advanced Vocabulary</h5>';
        currentAnalysis.vocabulary_highlights.forEach(vocab => {
          const levelColor = vocab.toefl_level === 'high' ? 'blue' : 'indigo';
          vocabHTML += `
            <div class="mb-3 p-3 bg-${levelColor}-50 border-l-4 border-${levelColor}-400 rounded-r">
              <div class="font-medium text-${levelColor}-700">"${vocab.word}"</div>
              <div class="text-sm text-gray-600 mt-1">${vocab.reason}</div>
              <div class="text-xs text-${levelColor}-600 mt-1 font-medium">
                Type: ${vocab.type} | TOEFL Level: ${vocab.toefl_level}
              </div>
            </div>`;
        });
        vocabHTML += '</div>';
      }
      
      // Add general vocabulary suggestions if available
      if (currentAnalysis.suggestions) {
        const vocabSuggestions = currentAnalysis.suggestions.filter(s => 
          s.toLowerCase().includes('vocabulary') || s.toLowerCase().includes('word')
        );
        if (vocabSuggestions.length > 0) {
          vocabHTML += '<div class="mb-4"><h5 class="font-semibold text-blue-600 mb-3 flex items-center"><span class="text-lg mr-2">üí°</span>Vocabulary Tips</h5>';
          vocabSuggestions.forEach(suggestion => {
            vocabHTML += `
              <div class="mb-3 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r">
                <div class="text-sm text-gray-700">${suggestion}</div>
              </div>`;
          });
          vocabHTML += '</div>';
        }
      }
      
      if (!vocabHTML) {
        vocabHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üìö</div>
            <div class="font-semibold">Vocabulary Analysis</div>
            <div class="text-sm">Continue writing to see advanced vocabulary usage and suggestions.</div>
          </div>`;
      }
      
      document.getElementById('feedback-vocabulary').innerHTML = vocabHTML;
    }

    function updateStructurePanel() {
      let structureHTML = '';
      
      if (currentAnalysis.coherence_analysis && currentAnalysis.coherence_analysis.length > 0) {
        structureHTML += '<div class="mb-4"><h5 class="font-semibold text-purple-600 mb-3 flex items-center"><span class="text-lg mr-2">üîÑ</span>Coherence Analysis</h5>';
        currentAnalysis.coherence_analysis.forEach(coherence => {
          const severityColor = coherence.severity === 'high' ? 'red' : coherence.severity === 'medium' ? 'yellow' : 'blue';
          structureHTML += `
            <div class="mb-3 p-3 bg-${severityColor}-50 border-l-4 border-${severityColor}-400 rounded-r">
              <div class="font-medium text-${severityColor}-700">${coherence.issue}</div>
              <div class="text-sm text-gray-600 mt-1">${coherence.suggestion}</div>
              ${coherence.paragraph ? `<div class="text-xs text-gray-500 mt-1">Paragraph: ${coherence.paragraph}</div>` : ''}
            </div>`;
        });
        structureHTML += '</div>';
      }
      
      if (currentAnalysis.development_feedback && currentAnalysis.development_feedback.length > 0) {
        structureHTML += '<div class="mb-4"><h5 class="font-semibold text-purple-600 mb-3 flex items-center"><span class="text-lg mr-2">üìà</span>Development Feedback</h5>';
        currentAnalysis.development_feedback.forEach(feedback => {
          structureHTML += `
            <div class="mb-3 p-3 bg-purple-50 border-l-4 border-purple-400 rounded-r">
              <div class="font-medium text-purple-700">${feedback.aspect}</div>
              <div class="text-sm text-gray-600 mt-1">${feedback.comment}</div>
              <div class="text-sm text-blue-600 mt-1">üí° ${feedback.suggestion}</div>
            </div>`;
        });
        structureHTML += '</div>';
      }
      
      // Add structure-related suggestions
      if (currentAnalysis.suggestions) {
        const structureSuggestions = currentAnalysis.suggestions.filter(s => 
          s.toLowerCase().includes('structure') || s.toLowerCase().includes('paragraph') || 
          s.toLowerCase().includes('organization') || s.toLowerCase().includes('transition')
        );
        if (structureSuggestions.length > 0) {
          structureHTML += '<div class="mb-4"><h5 class="font-semibold text-purple-600 mb-3 flex items-center"><span class="text-lg mr-2">üìù</span>Structure Tips</h5>';
          structureSuggestions.forEach(suggestion => {
            structureHTML += `
              <div class="mb-3 p-3 bg-purple-50 border-l-4 border-purple-400 rounded-r">
                <div class="text-sm text-gray-700">${suggestion}</div>
              </div>`;
          });
          structureHTML += '</div>';
        }
      }
      
      if (!structureHTML) {
        structureHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üèóÔ∏è</div>
            <div class="font-semibold">Structure Analysis</div>
            <div class="text-sm">Write more content to receive detailed feedback on essay structure and organization.</div>
          </div>`;
      }
      
      document.getElementById('feedback-structure').innerHTML = structureHTML;
    }

    function updateTOEFLPanel() {
      let toeflHTML = '';
      
      if (currentAnalysis.toefl_specific_tips && currentAnalysis.toefl_specific_tips.length > 0) {
        // Group tips by category
        const tipsByCategory = {};
        currentAnalysis.toefl_specific_tips.forEach(tip => {
          if (!tipsByCategory[tip.category]) {
            tipsByCategory[tip.category] = [];
          }
          tipsByCategory[tip.category].push(tip);
        });
        
        Object.keys(tipsByCategory).forEach(category => {
          const categoryIcon = {
            'task_response': 'üéØ',
            'organization': 'üìã',
            'language_use': 'üó£Ô∏è',
            'development': 'üìà',
            'general': 'üí°'
          };
          
          toeflHTML += `<div class="mb-4"><h5 class="font-semibold text-indigo-600 mb-3 flex items-center"><span class="text-lg mr-2">${categoryIcon[category] || 'üí°'}</span>${category.replace('_', ' ').toUpperCase()}</h5>`;
          
          tipsByCategory[category].forEach(tip => {
            const priorityColor = tip.priority === 'high' ? 'red' : tip.priority === 'medium' ? 'yellow' : 'blue';
            toeflHTML += `
              <div class="mb-3 p-3 bg-indigo-50 border-l-4 border-${priorityColor}-400 rounded-r">
                <div class="text-sm text-gray-700">${tip.tip}</div>
                <div class="text-xs text-indigo-600 mt-1 font-medium">Priority: ${tip.priority}</div>
              </div>`;
          });
          toeflHTML += '</div>';
        });
      }
      
      // Add general TOEFL suggestions
      if (currentAnalysis.suggestions) {
        const toeflSuggestions = currentAnalysis.suggestions.filter(s => 
          s.toLowerCase().includes('toefl') || s.toLowerCase().includes('score') || 
          s.toLowerCase().includes('exam') || s.toLowerCase().includes('test')
        );
        if (toeflSuggestions.length > 0) {
          toeflHTML += '<div class="mb-4"><h5 class="font-semibold text-indigo-600 mb-3 flex items-center"><span class="text-lg mr-2">üìã</span>General TOEFL Tips</h5>';
          toeflSuggestions.forEach(suggestion => {
            toeflHTML += `
              <div class="mb-3 p-3 bg-indigo-50 border-l-4 border-indigo-400 rounded-r">
                <div class="text-sm text-gray-700">${suggestion}</div>
              </div>`;
          });
          toeflHTML += '</div>';
        }
      }
      
      if (!toeflHTML) {
        toeflHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üéØ</div>
            <div class="font-semibold">TOEFL-Specific Tips</div>
            <div class="text-sm">TOEFL writing strategies and tips will appear here based on your essay.</div>
          </div>`;
      }
      
      document.getElementById('feedback-toefl').innerHTML = toeflHTML;
    }

    function updateOverallPanel() {
      let overallHTML = '';
      
      if (currentAnalysis.overall_assessment) {
        const assessment = currentAnalysis.overall_assessment;
        
        overallHTML += '<div class="space-y-4">';
        
        // Word count feedback
        if (assessment.word_count_feedback) {
          overallHTML += `
            <div class="p-4 bg-gray-50 rounded-lg">
              <h6 class="font-semibold text-gray-700 mb-2 flex items-center"><span class="text-lg mr-2">üìä</span>Word Count</h6>
              <div class="text-sm text-gray-600">${assessment.word_count_feedback}</div>
            </div>`;
        }
        
        // Essay structure
        if (assessment.essay_structure) {
          overallHTML += `
            <div class="p-4 bg-gray-50 rounded-lg">
              <h6 class="font-semibold text-gray-700 mb-2 flex items-center"><span class="text-lg mr-2">üèóÔ∏è</span>Essay Structure</h6>
              <div class="text-sm text-gray-600">${assessment.essay_structure}</div>
            </div>`;
        }
        
        // Argument strength
        if (assessment.argument_strength) {
          overallHTML += `
            <div class="p-4 bg-gray-50 rounded-lg">
              <h6 class="font-semibold text-gray-700 mb-2 flex items-center"><span class="text-lg mr-2">üí™</span>Argument Strength</h6>
              <div class="text-sm text-gray-600">${assessment.argument_strength}</div>
            </div>`;
        }
        
        // Estimated TOEFL band
        if (assessment.estimated_toefl_band) {
          overallHTML += `
            <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
              <h6 class="font-semibold text-blue-700 mb-2 flex items-center"><span class="text-lg mr-2">üéØ</span>Estimated TOEFL Score</h6>
              <div class="text-sm text-gray-600">${assessment.estimated_toefl_band}</div>
            </div>`;
        }
        
        overallHTML += '</div>';
      }
      
      // Add overall suggestions if available
      if (currentAnalysis.suggestions && currentAnalysis.suggestions.length > 0) {
        const generalSuggestions = currentAnalysis.suggestions.filter(s => 
          !s.toLowerCase().includes('vocabulary') && !s.toLowerCase().includes('structure') && 
          !s.toLowerCase().includes('toefl') && !s.toLowerCase().includes('word')
        );
        
        if (generalSuggestions.length > 0) {
          overallHTML += '<div class="mt-4"><h5 class="font-semibold text-gray-700 mb-3 flex items-center"><span class="text-lg mr-2">üí°</span>Key Recommendations</h5>';
          generalSuggestions.forEach(suggestion => {
            overallHTML += `
              <div class="mb-3 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r">
                <div class="text-sm text-gray-700">${suggestion}</div>
              </div>`;
          });
          overallHTML += '</div>';
        }
      }
      
      if (!overallHTML) {
        overallHTML = `
          <div class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">üìä</div>
            <div class="font-semibold">Overall Assessment</div>
            <div class="text-sm">A comprehensive summary of your essay will appear here.</div>
          </div>`;
      }
      
      document.getElementById('feedback-overall').innerHTML = overallHTML;
    }

    // Highlight text in the writing area with improved precision
    function highlightText() {
      if (!currentAnalysis) return;
      
      const textarea = document.getElementById('user-essay');
      const displayDiv = document.getElementById('writing-display');
      const text = textarea.value;
      
      let highlightedText = escapeHtml(text);
      
      // Create a list of all highlights with priorities
      const allHighlights = [];
      
      // Add spelling errors (highest priority - red)
      if (currentAnalysis.spelling_errors) {
        currentAnalysis.spelling_errors.forEach(error => {
          addHighlightToList(allHighlights, error.word, 'spelling-error', 4);
        });
      }
      
      // Add grammar issues (high priority - red underline)
      if (currentAnalysis.grammar_issues) {
        currentAnalysis.grammar_issues.forEach(issue => {
          addHighlightToList(allHighlights, issue.text, 'grammar-error', 3);
        });
      }
      
      // Add weaknesses (medium priority - yellow)
      if (currentAnalysis.weaknesses) {
        currentAnalysis.weaknesses.forEach(weakness => {
          addHighlightToList(allHighlights, weakness.text, 'weakness', 2);
        });
      }
      
      // Add vocabulary highlights (low priority - blue)
      if (currentAnalysis.vocabulary_highlights) {
        currentAnalysis.vocabulary_highlights.forEach(vocab => {
          addHighlightToList(allHighlights, vocab.word, 'vocab-highlight', 1);
        });
      }
      
      // Add strengths (low priority - green)
      if (currentAnalysis.strengths) {
        currentAnalysis.strengths.forEach(strength => {
          addHighlightToList(allHighlights, strength.text, 'strength', 1);
        });
      }
      
      // Sort highlights by priority (highest first) and then by length (longest first)
      allHighlights.sort((a, b) => {
        if (a.priority !== b.priority) return b.priority - a.priority;
        return b.text.length - a.text.length;
      });
      
      // Apply highlights
      allHighlights.forEach(highlight => {
        const regex = new RegExp(`\\b${escapeRegExp(highlight.text)}\\b`, 'gi');
        highlightedText = highlightedText.replace(regex, (match) => {
          return `<span class="${getHighlightClass(highlight.type)}" title="${getHighlightTitle(highlight.type)}">${match}</span>`;
        });
      });
      
      // Replace line breaks for display
      highlightedText = highlightedText.replace(/\n/g, '<br>');
      
      displayDiv.innerHTML = highlightedText;
      displayDiv.style.opacity = '1';
      
      // Auto-hide highlights after 8 seconds
      setTimeout(() => {
        if (displayDiv.style.opacity === '1') {
          displayDiv.style.opacity = '0.7';
        }
      }, 8000);
    }

    // Helper function to add highlights to list
    function addHighlightToList(list, text, type, priority) {
      if (text && text.trim().length > 0) {
        list.push({
          text: text.trim(),
          type: type,
          priority: priority
        });
      }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Helper function to escape regex special characters
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Helper function to get CSS class for highlight type
    function getHighlightClass(type) {
      switch (type) {
        case 'spelling-error':
          return 'highlight-error';
        case 'grammar-error':
          return 'highlight-grammar';
        case 'weakness':
          return 'highlight-weakness';
        case 'vocab-highlight':
          return 'highlight-vocab';
        case 'strength':
          return 'highlight-strength';
        default:
          return 'highlight-default';
      }
    }

    // Helper function to get tooltip title for highlight type
    function getHighlightTitle(type) {
      switch (type) {
        case 'spelling-error':
          return 'Spelling Error - Check the errors panel for suggestions';
        case 'grammar-error':
          return 'Grammar Issue - Check the errors panel for details';
        case 'weakness':
          return 'Area for Improvement - Check the errors panel for suggestions';
        case 'vocab-highlight':
          return 'Advanced Vocabulary - Great word choice!';
        case 'strength':
          return 'Writing Strength - Excellent work!';
        default:
          return 'Highlighted text';
      }
    }

    // Clear highlights with smooth transition
    function clearHighlights() {
      const displayDiv = document.getElementById('writing-display');
      displayDiv.style.opacity = '0';
      setTimeout(() => {
        displayDiv.innerHTML = '';
      }, 300);
    }

    // Tab switching event listeners
    document.getElementById('tab-generate').addEventListener('click', showGenerateMode);
    document.getElementById('tab-write').addEventListener('click', showWriteMode);
    
    // Writing analysis event listeners
    document.getElementById('user-essay').addEventListener('input', updateWordCount);
    document.getElementById('check-writing').addEventListener('click', checkWritingManually);
    document.getElementById('clear-highlights').addEventListener('click', clearHighlights);
    document.getElementById('toggle-analysis').addEventListener('click', toggleAnalysisPanel);
    document.getElementById('close-analysis').addEventListener('click', hideAnalysisPanel);
    
    // Feedback tab event listeners
    document.getElementById('tab-errors').addEventListener('click', () => switchFeedbackTab('errors'));
    document.getElementById('tab-strengths').addEventListener('click', () => switchFeedbackTab('strengths'));
    document.getElementById('tab-vocabulary').addEventListener('click', () => switchFeedbackTab('vocabulary'));
    document.getElementById('tab-structure').addEventListener('click', () => switchFeedbackTab('structure'));
    document.getElementById('tab-toefl').addEventListener('click', () => switchFeedbackTab('toefl'));
    document.getElementById('tab-overall').addEventListener('click', () => switchFeedbackTab('overall'));
    
    // Initialize feedback tab
    switchFeedbackTab('errors');

    // Auto-show analysis panel when checking writing
    const originalCheckWriting = checkWritingManually;
    checkWritingManually = async function() {
      await originalCheckWriting.call(this);
      // Show analysis panel after checking
      if (currentAnalysis) {
        showAnalysisPanel();
      }
    };

    document.getElementById('generate').addEventListener('click', async () => {
      const promptSelect = document.getElementById('prompt');
      currentPrompt = promptSelect.options[promptSelect.selectedIndex].text;
      
      // Show loading state
      document.getElementById('sample').innerHTML = '<div style="text-align: center; padding: 40px; color: #6B7280;">üîÑ Generating essay... Please wait.</div>';
      
      const response = await fetch('/generate_sample', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ prompt: currentPrompt }),
      });

      const data = await response.json();
      if (data.sample) {
        currentEssay = data.sample;
        document.getElementById('sample').innerHTML = data.sample;
        document.getElementById('score').style.display = 'block';
      } else {
        document.getElementById('sample').textContent = 'Error generating sample.';
      }
    });

    document.getElementById('score').addEventListener('click', async () => {
      if (!currentEssay || !currentPrompt) {
        alert('Please generate an essay first.');
        return;
      }

      // Show scoring section and loading state
      document.getElementById('scoring-section').style.display = 'block';
      document.getElementById('scoring').innerHTML = '<div style="text-align: center; padding: 40px; color: #6B7280;">üìä Analyzing and scoring essay... Please wait.</div>';

      // Extract text content from HTML for scoring
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = currentEssay;
      const essayText = tempDiv.textContent || tempDiv.innerText || '';

      const response = await fetch('/score_essay', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          essay: essayText,
          prompt: currentPrompt 
        }),
      });

      const data = await response.json();
      if (data.scoring) {
        document.getElementById('scoring').innerHTML = data.scoring;
      } else {
        document.getElementById('scoring').textContent = 'Error scoring essay.';
      }
    });

    // Score user's own essay
    document.getElementById('score-user-essay').addEventListener('click', async () => {
      const userEssay = document.getElementById('user-essay').value.trim();
      const promptSelect = document.getElementById('prompt');
      currentPrompt = promptSelect.options[promptSelect.selectedIndex].text;
      
      if (!userEssay) {
        alert('Please write your essay first.');
        return;
      }

      if (userEssay.split(/\s+/).length < 50) {
        alert('Your essay is too short. Please write at least 50 words.');
        return;
      }

      // Show scoring section and loading state
      document.getElementById('scoring-section').style.display = 'block';
      document.getElementById('scoring').innerHTML = '<div style="text-align: center; padding: 40px; color: #6B7280;">üìä Analyzing and scoring your essay... Please wait.</div>';

      const response = await fetch('/score_essay', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          essay: userEssay,
          prompt: currentPrompt 
        }),
      });

      const data = await response.json();
      if (data.scoring) {
        document.getElementById('scoring').innerHTML = data.scoring;
      } else {
        document.getElementById('scoring').textContent = 'Error scoring essay.';
      }
    });
  </script>
  
  <style>
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    .tab-button {
      transition: all 0.3s ease;
    }
    
    .tab-button:hover {
      background-color: #f8fafc;
    }
    
    .mode-content {
      transition: all 0.3s ease;
    }
    
    .feedback-tab {
      transition: all 0.3s ease;
    }
    
    .feedback-tab:hover {
      background-color: #f8fafc;
    }
    
    /* Writing overlay styles */
    #writing-display {
      font-size: 14px;
      overflow: hidden;
      pointer-events: none;
    }
    
    #user-essay:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Enhanced highlight styles */
    .highlight-error {
      background-color: rgba(239, 68, 68, 0.2);
      border-bottom: 2px wavy #ef4444;
      padding: 1px 2px;
      border-radius: 2px;
      animation: fadeInHighlight 0.5s ease-in;
    }
    
    .highlight-grammar {
      background-color: rgba(239, 68, 68, 0.15);
      border-bottom: 2px dotted #ef4444;
      padding: 1px 2px;
      border-radius: 2px;
      animation: fadeInHighlight 0.5s ease-in;
    }
    
    .highlight-weakness {
      background-color: rgba(251, 191, 36, 0.2);
      border-bottom: 2px solid #f59e0b;
      padding: 1px 2px;
      border-radius: 2px;
      animation: fadeInHighlight 0.5s ease-in;
    }
    
    .highlight-vocab {
      background-color: rgba(59, 130, 246, 0.2);
      border-bottom: 2px solid #3b82f6;
      padding: 1px 2px;
      border-radius: 2px;
      animation: fadeInHighlight 0.5s ease-in;
    }
    
    .highlight-strength {
      background-color: rgba(34, 197, 94, 0.2);
      border-bottom: 2px solid #22c55e;
      padding: 1px 2px;
      border-radius: 2px;
      animation: fadeInHighlight 0.5s ease-in;
    }
    
    .highlight-default {
      background-color: rgba(156, 163, 175, 0.2);
      border-bottom: 1px solid #9ca3af;
      padding: 1px 2px;
      border-radius: 2px;
    }
    
    /* Highlight animations */
    @keyframes fadeInHighlight {
      0% { 
        background-color: transparent; 
        transform: scale(1);
      }
      50% {
        transform: scale(1.02);
      }
      100% { 
        background-color: inherit; 
        transform: scale(1);
      }
    }
    
    /* Analysis panel styles */
    #analysis-panel {
      backdrop-filter: blur(10px);
      background-color: rgba(255, 255, 255, 0.95);
    }
    
    /* Responsive design for smaller screens */
    @media (max-width: 1024px) {
      #analysis-panel {
        width: 100%;
        transform: translateY(100%);
      }
      
      #analysis-panel:not(.translate-x-full) {
        transform: translateY(0);
      }
      
      .translate-x-full {
        transform: translateY(100%) !important;
      }
    }
    
    /* Smooth transitions for panel */
    #analysis-panel {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Custom scrollbar for analysis panel */
    #feedback-content::-webkit-scrollbar {
      width: 6px;
    }
    
    #feedback-content::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    
    #feedback-content::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    #feedback-content::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</body>

</html>
